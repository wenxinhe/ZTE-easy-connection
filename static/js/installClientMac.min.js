/**
 * æœ¬æ–‡ä»¶ç”¨äºinstallClient.htmlå’ŒinstallClient_en.htmlçš„ç›¸å…³jsä»£ç 
 */
/**
 * å…¨å±€å˜é‡
 * 1.baseLinkï¼šå…¬å¸å¹³å°çš„åŒ…åœ°å?
 *      http://download.sangfor.com.cn/download/product/sslvpn/pkg/mac_01/EasyConnect.dmg
 *      åé¢+ç³»åˆ—å·ï¼Œ+åŒ…åï¼? EasyConnect.dmgï¼? linux_x86.debï¼? linux_x64.debï¼? linux_x86.rpmï¼? linux_x64.rpm
 * 2.g_install_device
 *      è®¾å¤‡çš„ä¸‹è½½åœ°å?
 *      å…¶ä¸­çš„åœ°å?æ˜¯é»˜è®¤_01ç³»åˆ—å·åœ°å?ï¼Œä»¥é˜²xmlåŠ è½½å‡ºé”™
 */
var baseLink="http://download.sangfor.com.cn/download/product/sslvpn/pkg/";
var g_install_device = {
    mac: {
        link: "/com/EasyConnect.dmg"
    },
    linux:{
        link:{
            "deb_x86":baseLink+"linux_01/EasyConnect_x86.deb",
            "deb_x64":baseLink+"linux_01/EasyConnect_x64.deb",
            "rpm_x86":baseLink+"linux_01/EasyConnect_x86.rpm",
            "rpm_x64":baseLink+"linux_01/EasyConnect_x64.rpm"
        }
    }
};

/**
 * åŠ è½½è§£æxmlæ–‡ä»¶ï¼Œåˆå§‹åŒ–å…¨å±€å˜é‡
 */
function loadXML(){
    $.ajax({
        type: "get",
        url: "/por/ec_pkg.csp?platform=all"+"&id="+Math.floor(1000*Math.random()),
        // url: "https://199.201.72.164/por/ec_pkg.csp?platform=all&hash=23",
        dataType:"xml",
        success: function(msg){
            var xmlDoc=msg;
            var xmlObj=xmlToJSON.parseXML(xmlDoc);
            if(typeof xmlObj.root.linux.deb.x86.info.link==="object"||xmlObj.root.linux.deb.x86.info.custom==="0"){
                g_install_device.linux.link.deb_x86=baseLink+xmlObj.root.linux.deb.x86.alias+"/EasyConnect_x86.deb";
            }else{
                g_install_device.linux.link.deb_x86=xmlObj.root.linux.deb.x86.info.link;
            }

            if(typeof xmlObj.root.linux.deb.x64.info.link==="object"||xmlObj.root.linux.deb.x64.info.custom==="0"){
                g_install_device.linux.link.deb_x64=baseLink+xmlObj.root.linux.deb.x64.alias+"/EasyConnect_x64.deb";
            }else{
                g_install_device.linux.link.deb_x64=xmlObj.root.linux.deb.x64.info.link;
            }

            if(typeof xmlObj.root.linux.rpm.x86.info.link==="object"||xmlObj.root.linux.rpm.x86.info.custom==="0"){
                g_install_device.linux.link.rpm_x86=baseLink+xmlObj.root.linux.rpm.x86.alias+"/EasyConnect_x86.rpm";
            }else{
                g_install_device.linux.link.rpm_x86=xmlObj.root.linux.rpm.x86.info.link;
            }

            if(typeof xmlObj.root.linux.rpm.x64.info.link==="object"||xmlObj.root.linux.rpm.x64.info.custom==="0"){
                g_install_device.linux.link.rpm_x64=baseLink+xmlObj.root.linux.rpm.x64.alias+"/EasyConnect_x64.rpm";
            }else{
                g_install_device.linux.link.rpm_x64=xmlObj.root.linux.rpm.x64.info.link;
            }

            if(typeof xmlObj.root.mac.info.link==="object"||xmlObj.root.mac.info.custom==="0"){
                g_install_device.mac.link=baseLink+xmlObj.root.mac.alias+"/EasyConnect.dmg";
            }else{
                g_install_device.mac.link=xmlObj.root.mac.info.link;
            }

            //è®¾ç½®linuxåŒ…è·¯å¾?
            initPath();

        },
        error:function(XMLHttpRequest, textStatus, errorThrown){
            //è®¾ç½®linuxåŒ…è·¯å¾?
            initPath();/*
            // console.error("cannot load xml");
            // console.log(XMLHttpRequest);
            // console.log(textStatus);
            // console.log(errorThrown);*/
        }
    });
}

/**
 * æ£?æµ‹æ“ä½œç³»ç»?
 * @returns[0] String:ç³»ç»Ÿålinux/mac/windows/android/ios
 * @returns[1] Object:linuxç³»ç»Ÿä¿¡æ¯ï¼ˆç‰ˆæœ¬ä½æ•°ï¼‰,æ ¼å¼å¦‚ä¸‹
 * {
 * isLinux:isLinux,
 * version:linuxVersion,
 * bits:linuxBits
 * }
 */
function osDetect(){
    var UA=navigator.userAgent.toLowerCase();
    var p=navigator.platform.toLowerCase();
    var isWin =!!(UA.match(/(windows)/i)) || (p==="windows");
    var isMac = !!p.match(/(macintosh|mac68k|macppc|macintel)/i);
    var isIos=!!(p.match(/(iphone|ipod|ipad)/i)) || !!(UA.match(/(iphone|ipod|ipad|like mac os x)/i));
    var isAndroid=!!UA.match(/(android)/i);
    var isLinux = !!(p.match(/(linux|x11)/i)) || !!(UA.match(/(linux|x11)/i));
    var linuxVersion=(UA.match(/(ubuntu)/i)) ?  "deb" : "rpm";
    var linuxBits=(UA.match(/(x86_64|x86-64|x64|amdx64)/i)) ?  "x64" : "x86";
    var system={
        windows:isWin,
        mac:isMac,
        ios:isIos,
        android:isAndroid,
        linux:{
            isLinux:isLinux,
            version:linuxVersion,
            bits:linuxBits
        }
    };
    return (function(){
        for(var key in system){
            if(system[key].isLinux){
                return [key,system[key]];
            }else if(system[key]){
                return [key,{}];
            }
        }
        return ["windows",{}];
    })();
}

/**
 * åˆå§‹åŒ–linux/macä¸‹è½½åŒ…é“¾æ?
 */
function initPath(){
    $("#deb_x86").attr("href",g_install_device.linux.link.deb_x86);
    $("#deb_x64").attr("href",g_install_device.linux.link.deb_x64);
    $("#rpm_x86").attr("href",g_install_device.linux.link.rpm_x86);
    $("#rpm_x64").attr("href",g_install_device.linux.link.rpm_x64);
    $("#macLink").attr("href",g_install_device.mac.link);
}

/**
 * æ ¹æ®navæŒ‰é’®çš„è®¾å¤‡ådeviceNameæ›´æ–°é¡µé¢å½“å‰æ˜¾ç¤ºå†…å®¹ + åˆ‡æ¢æŒ‰é’®é€‰ä¸­æ ·å¼
 * @param deviceNameï¼šwindows/linux/mac/ios/android
 */
function update(deviceName){
    var li=$("#"+deviceName);
    //æ›´æ–°é¡µé¢å½“å‰æ˜¾ç¤ºå†…å®¹
    var mainWidth=$(".main").width();
    var navWidth=$(".deviceBtn").width();
    var mainMoveLeft=(li.index()-1)*mainWidth*-1;
    var navMoveLeft=(li.index()-1)*navWidth;
    $(".ulbox").animate({"left":mainMoveLeft},400);
    $("#navAnim").animate({"left":navMoveLeft},400);
    //åˆ‡æ¢æŒ‰é’®é€‰ä¸­æ ·å¼
    li.siblings().filter(function(){
        $(this).removeClass($(this).attr("id")+"ActiveBtn");
        $(this).removeClass("activeBtn clickedBtn");
    });
    li.addClass("activeBtn clickedBtn");
    li.addClass(deviceName+"ActiveBtn");
}

/**
 * åˆå§‹åŒ–äº‹ä»?
 */
function initEvent() {
    //åŠ è½½xmlï¼Œåˆå§‹åŒ–å…¨å±€å˜é‡
    //loadXML();
    initPath();
    //æ ¹æ®æ“ä½œç³»ç»Ÿåˆå§‹åŒ?
    update(osDetect()[0]);
    //navæŒ‰é’®ç‚¹å‡»åˆ‡æ¢æ ·å¼
    var deviceBtn=$(".deviceBtn");
    deviceBtn.click(function(){
        update($(this).attr("id"));
    });
    //navæŒ‰é’®æ‚¬æµ®åˆ‡æ¢æ ·å¼
    deviceBtn.hover(function(){
        if(!$(this).hasClass("clickedBtn")){
            $(this).addClass($(this).attr("id")+"ActiveBtn");
            $(this).addClass("activeBtn");
            $(this).siblings("li").filter(function(){
                $(this).removeClass($(this).attr("id")+"ActiveBtn");
                $(this).removeClass("activeBtn");
            });
        }
    },function(){
        $(this).parent().children().removeClass("activeBtn");
        $(this).parent().children().filter(function(){
            $(this).removeClass($(this).attr("id")+"ActiveBtn");
        });
        var clickedBtn=$(".clickedBtn");
        clickedBtn.addClass("activeBtn");
        clickedBtn.addClass(clickedBtn.attr("id")+"ActiveBtn");
    });

}

/**
 * æ£?æŸ¥å®‰è£…æƒ…å†?
 */
function checkEcAgentInstall() {
    initEcAgent({
        success: function (data) {
            var result = data.result;
            if (result === "-2" || result === "-3") {
                //åˆå§‹åŒ–å¤±è´?, éœ?è¦é‡æ–°å®‰è£?
                console.error("EcAgent: InitEcAgent failed, Not support update (-3) or Ecbase not exist(-2)! Go to re-install! Result is:", result);
                checkEcAgentInstallLater();
            } else {
                //æˆåŠŸ
                console.debug("EcAgent: InitEcAgent success, return last page!");
                //è¿”å›åˆ°ç™»å½•é¡µé?, å› ä¸ºéƒ½æ˜¯åœ¨ç™»å½•å‰æ£?æŸ¥å®‰è£…æ—¶è·³è½¬è¿‡æ¥çš?
                location.href = "/";
            }
        },
        error: function () {
            console.debug("EcAgent: InitEcAgent failed, Check later.");
            checkEcAgentInstallLater();
        }
    });
}

/**
 * ç¨åå†æ£€æŸ¥å®‰è£…æƒ…å†?
 */
function checkEcAgentInstallLater() {
    setTimeout(function () {
        checkEcAgentInstall();
        //6s æ£?æŸ¥ä¸€æ¬?
    }, 6000);
}

$(function () {
    initEvent();
    checkEcAgentInstallLater();
});