function setLoginDisable(a){var b=$ID(client.N_LOGFORM);if(b)for(var c=0,d=b.elements.length;d>c;c++){var e=b.elements[c];e.type&&(e.disabled=a)}}function showHelpLink(){if($ID("helper"))doShow("helper");else{requireCss("/com/css/helper.css");var a="zh_CN"===window.language?"/com/help/":"/com/help_en/",b='<div class="link_bar" id="_link_bar"><a class="helper" href="'+a+'" target="_blank">'+tr("帮助")+"</a></div>";append(document.body,b)}}function showLanguageLink(){var a=$ID("language");if(a){var b=is.Language();if("zh-cn"!==b)a.style.display="none";else if(a.style.display="",$ID("zh_CN")&&$ID("en_US")){var c=$ID("zh_CN"),d=$ID("en_US");c&&"zh_CN"===window.language&&(c.removeAttribute("href"),c.className="zh_CN_disable"),d&&"zh_CN"!==window.language&&(d.removeAttribute("href"),d.className="en_US_disable")}}}function reTranslateString(){return"zh_CN"===language?!1:(["NORMAL_LOGIN","ANONYMOUS_LOGIN","ANONYMOUS_USER","NEED_USERNAME","INVALID_USER","NEED_RANDCODE","LOGING"].forEach(function(a){window.client.content[a]=tr(window.client.content[a])}),!0)}function checkReLoginEx(){return G.info.isReLogin}function switchAnonymousLogin(){var a=$ID(client.N_INPUTNAME),b=$ID(client.N_BUTTONNAME),c=getCookie("CERT_USERNAME");if("1"==client.EnableAnonymous&&0==c){var d=$ID(client.N_ANONYBUTTONNAME);d?d.style.display="":b.innerHTML=a.value.length>0?client.content.NORMAL_LOGIN:client.content.ANONYMOUS_LOGIN}}function isAnonymousButton(){return $ID(client.N_BUTTONNAME).innerHTML==client.content.ANONYMOUS_LOGIN}function autoAnonymousLogin(){"1"==client.EnableAnonymous&&"1"==client.denyNormalAccess&&(""!=errorMsg&&(alert(errorMsg),close()),setLoginDisable(!1),anonymousLogin())}function anonymousLogin(){$ID(client.N_INPUTNAME).value=client.content.ANONYMOUS_USER,$ID(client.N_INPUTPASS).value="",$ID("randcode").value="",LoginState.publish("onAnonymousLogin")}function formSubmit(){return LoginState.publish("onFormSubmit"),!1}function onInputNameFocus(){"1"==client.EnableAnonymous&&($ID(client.N_BUTTONNAME).innerHTML=client.content.NORMAL_LOGIN)}function onInputNameBlur(){switchAnonymousLogin()}function onButtonMouseMove(){switchAnonymousLogin()}function onInstall(a){var b="width=400,height=160,top=100,left=100,resizable=yes,location=no,menubar=no,scrollbars=no,status=no";window.open("../com/setup.html?"+a,"install",b)}function HandleDkey(){var a=navigator.userAgent.toLowerCase();a.indexOf("edge")>=0?alert(tr("Edge浏览器暂不支持USB-Key登录，请更换其他浏览器")):window.location="dkey_portal.csp"}function HelpCenter(){var a="zh_CN"===window.language?"../com/help/":"../com/help_en/";window.open(a)}function ChangeRandCode(){var a=$ID(client.N_RANDCODEIMG);a.src="/por/rand_code.csp?rnd="+Math.random()}function CertLogin(){setCookie("UsingDkey","0"),self.location.href="login_cert.csp"}function closeSoftKb(){"1"==client.EnableKeypad&&closekeyboard()}function initEvent(){if(null!=$ID(client.N_INPUTNAME))try{$ID(client.N_INPUTNAME).focus()}catch(a){}addEvent($ID(client.N_INPUTPASS),"focus",function(){this.select()})}function showMidAttackTips(){alert(tr("服务器启用中间人攻击检测，不允许使用IE代理登录")+tr("SSLVPN"))}function showProxyTesttingTips(){showMsg("load",tr("正在测试代理服务器..."))}function showClientUpdatingTips(){showMsg("load",tr("正在检查更新..."))}function initDisplay(){var a="true"!=client.N_HIDEBUTTONS?doShow:doHide;a("loginTypes"),a(client.N_SIGNINBYCERT),a(client.N_SIGNINBYDKEY),"1"==client.EnableResetPsw?doShow("resetpsw"):doHide("resetpsw"),doShow(client.N_COMPLAYER),doShow("SangforTool"),"0"!=client.EnableDKeyVer?doShow(client.N_DKEYTIPS):doHide(client.N_DKEYTIPS),doHide(client.N_MACSYSTEM),getCookie("UsingDkey")==G.dkey.ready&&CertLogin(),"1"==client.EnableRandCode?($ID(client.N_INPUTRAND).getElementsByTagName("img")[0].src="/por/rand_code.csp",doShow(client.N_INPUTRAND)):doHide(client.N_INPUTRAND),""!=errorMsg&&-1==errorMsg.indexOf(tr("尝试暴破登录，启用图形校验码"))?showMsg("error",errorMsg):hideMsg()}function showCheckFailedTips(){alert(tr("没有通过安全检查,不能登录"))}function setLoading(){$ID(client.N_BUTTONNAME).disabled=!0,showMsg("load",client.content.LOGING)}function initCookie(){delCookie("is_reminded"),delCookie("only_use_webrc"),delCookie("webonly"),delCookie("isWebSvcLogout"),setCookie("g_LoginPage","login_psw"),setCookie("VisitTimes","0"),setCookie("haveLogin","0")}function noteComeFrom(){var a=location.href.lastIndexOf("#"),b="";-1!=a&&location.href.length>a+1?(b=location.href.substr(a+1),b=decodeURIComponent(b)):b=location.href,b=b.replace(/\?.*/,""),setCookie("VpnLine",b)}function initEcAgentBeforeLogin(){LoginState.publish("beforeInitEcAgent"),initEcAgent({success:function(a){var b=a.result;"1"===b?(LoginState.publish("haveCscm"),LoginState.publish("afterInitEcAgent")):"-1"===b?(LoginState.publish("noCscm"),LoginState.publish("afterInitEcAgent")):"-2"===b?LoginState.publish("initEcAgentFailed"):LoginState.publish("afterInitEcAgent")},lastPortError:function(){LoginState.publish("lastPortCheckFailed")},error:function(){LoginState.publish("initEcAgentFailed")}}),LoginState.publish("doingInitEcAgent")}function checkUpdateBeforeLogin(){LoginState.publish("beforeUpdate"),checkUpdate("BEFORELOGIN",{success:function(){LoginState.publish("afterUpdate")}}),LoginState.publish("doingUpdate")}function syncLanguage(){if(LoginState.publish("beforeSyncLanguage"),window.language){var a=window.language||"zh_CN";EcAgent("DoConfigure",["SET LANG "+a],{noSession:!0,success:function(a){"1"===a.result&&LoginState.publish("afterSyncLanguage")}}),LoginState.publish("doingSyncLanguage")}else EcAgent("DoQueryService",["QUERY LANG"],{noSession:!0,success:function(a){var b;a&&a.result&&(b=a.result,is.inside(G.language.list,b)||(b=!1)),loadLanguage(b,!1,function(){LoginState.publish("afterSyncLanguage")})}}),LoginState.publish("doingSyncLanguage")}function rsaEncrypt(a){var b;b=new RSAKey;var c="undefined"!=typeof client.EncryptExp?client.EncryptExp:"65537";b.setPublic(client.EncryptKey,parseInt(c).toString(16));var d=b.encrypt(a);return d?d:""}function checkMidAttack(){return 1!=client.EnableMidAtkCheck?(LoginState.publish("notNeedCheckMidAttack"),!1):(LoginState.publish("needCheckMidAttack"),LoginState.publish("beforeCheckMidAttack"),EcAgent("CheckMITMAttack",null,{noSession:!0,success:function(a){a&&"0"!==a.result?(LoginState.publish("haveMidAttack"),alert(tr("你访问的SSL VPN正遭受中间人攻击，将不能使用用户名/密码认证！"))):LoginState.publish("noMidAttack"),LoginState.publish("afterCheckMidAttack")}}),void LoginState.publish("doingCheckMidAttack"))}function checkProxyStatus(){LoginState.publish("beforeCheckProxy"),checkProxy({haveProxy:function(){LoginState.publish("haveProxy"),LoginState.publish("afterCheckProxy")},noProxy:function(){LoginState.publish("noProxy"),LoginState.publish("afterCheckProxy")}}),LoginState.publish("doingCheckProxy")}function testProxyServer(){LoginState.publish("beforeTestProxy"),testProxy({success:function(){LoginState.publish("afterTestProxy")}}),LoginState.publish("doingTestProxy")}function checkIsReLogin(){LoginState.publish("beforeCheckReLogin"),checkReLogin({preventDefault:!0,notLogin:function(){LoginState.publish("notReLogin"),G.info.isReLogin=!1},otherLogin:function(){G.info.isReLogin=!0,LoginState.publish("reLogin")},success:function(){LoginState.publish("afterCheckReLogin")}}),LoginState.publish("doingCheckReLogin")}function getMidAttackResult(){LoginState.publish("beforeGetMidAttackResult");var a=$ID(client.N_INPUTNAME).value,b=LoginEncrypt.password,c=$ID("randcode").value.toLowerCase();EcAgent("GetMITEMAttackResult",[a,b,c],{noSession:!0,success:function(a){$ID("txtMITEMAttack").value=a.result;var b=$ID("randcode"),d=$ID("txtMITEMAttack").parentNode,e=createHidden("svpn_rand_code");b.id="_randcode",b.name="_randcode",b.value="",e.value=hex_md5(c),d.appendChild(e),$ID(client.N_INPUTPASS).value="",LoginEncrypt.password="",LoginState.publish("afterGetMidAttackResult")}}),LoginState.publish("doingGetMidAttackResult")}function setStartTime(){EcAgent("SetSvpnStartTime",null,{noSession:!0,error:new Function})}function checkInput(){var a=!0,b="",c=$ID(client.N_INPUTNAME).value.trim();$ID(client.N_INPUTNAME).value=c,""==c&&(showMsg("error",client.content.NEED_USERNAME),$ID(client.N_INPUTNAME).focus(),a=!1),mbStringLength(c)>72&&(showMsg("error",client.content.INVALID_USER),$ID(client.N_INPUTNAME).focus(),a=!1),"1"==client.EnableRandCode&&(b=$ID("randcode").value,""==b&&(showMsg("error",client.content.NEED_RANDCODE),$ID("randcode").focus(),a=!1)),a?LoginState.publish("inputValid"):LoginState.publish("notInputValid")}function doSubmit(){LoginState.publish("doingFormSubmit");var a=$ID(client.N_LOGFORM);a.onsubmit=function(){return!0},a.submit(),LoginState.publish("afterFormSubmit")}var LoginState=LoginState||new StateManager;LoginState.subscribe(["jsLoad"]).callback(function(){initCookie(),noteComeFrom(),initEcAgentBeforeLogin()}),LoginState.subscribe(["onload"]).callback(function(){setLoginDisable(!0)}),LoginState.subscribe(["initEcAgentFailed"]).callback(function(){goInstallClient()}),LoginState.subscribe(["noCscm","afterInitEcAgent","onload"]).subscribe(["lastPortCheckFailed","onload"]).callback(function(){loadLanguage(window.language)}),LoginState.subscribe(["afterInitEcAgent"]).callback(function(){syncLanguage()}),LoginState.subscribe(["haveCscm","afterInitEcAgent"]).subscribe(["noCscm","afterUpdate"]).callback(function(){checkIsReLogin()}),LoginState.subscribe(["reLogin","afterSyncLanguage","onload"]).callback(function(){showReLoginTips()},0),LoginState.subscribe(["haveCscm","readyLogin"]).subscribe(["noCscm","afterInitEcAgent"]).callback(function(){checkProxyStatus()}),LoginState.subscribe(["haveProxy","onload","afterSyncLanguage"]).callback(function(){testProxyServer()}),LoginState.subscribe(["noProxy"]).subscribe(["haveProxy","afterTestProxy"]).callback(function(){checkUpdateBeforeLogin()}),LoginState.subscribe(["onload","haveCscm","afterInitEcAgent","afterSyncLanguage"]).subscribe(["onload","noCscm","afterUpdate"]).callback(function(){reTranslateString(),initDisplay(),showHelpLink(),showLanguageLink(),switchAnonymousLogin(),autoAnonymousLogin(),checkMidAttack()}),LoginState.subscribe(["needCheckMidAttack","noMidAttack","haveProxy"]).callback(function(){showMidAttackTips()}),LoginState.subscribe(["onload","noProxy","notReLogin"]).subscribe(["onload","notNeedCheckMidAttack","notReLogin"]).subscribe(["onload","noMidAttack","notReLogin"]).callback(function(){setLoginDisable(!1),initEvent(),LoginState.unPublish("reLogin"),LoginState.unPublish("notReLogin"),LoginState.publish("readyLogin")}),LoginState.subscribe(["onFormSubmit","doingUpdate"]).callback(function(){showClientUpdatingTips()},0),LoginState.subscribe(["onFormSubmit","doingTestProxy"]).callback(function(){showProxyTesttingTips()},0),LoginState.subscribe(["readyLogin","afterUpdate","onFormSubmit"]).callback(function(){LoginState.unPublish("inputValid"),LoginState.unPublish("notInputValid"),LoginState.unPublish("reLogin"),LoginState.unPublish("notReLogin"),LoginState.unPublish("afterCheckReLogin"),LoginState.unPublish("afterGetMidAttackResult"),isAnonymousButton()?anonymousLogin():checkIsReLogin()},0),LoginState.subscribe(["onFormSubmit","readyLogin","notReLogin"]).callback(function(){checkInput()},0),LoginState.subscribe(["inputValid"]).callback(function(){setLoading(),LoginEncrypt.encrypt()},0),LoginState.subscribe(["inputValid","needCheckMidAttack","noMidAttack"]).callback(function(){getMidAttackResult()},0),LoginState.subscribe(["inputValid","needCheckMidAttack","haveMidAttack"]).callback(function(){showCheckFailedTips()},0),LoginState.subscribe(["inputValid","notNeedCheckMidAttack"]).subscribe(["afterGetMidAttackResult"]).callback(function(){LoginEncrypt.setInput(),doSubmit()},0),LoginState.subscribe(["onAnonymousLogin"]).callback(function(){setLoading(),doSubmit()},0);var doHide=function(){return window.tmlversion<5.35?function(a){a="string"==typeof a?document.getElementById(a):a,a&&(a.className="hide")}:function(a){a="string"==typeof a?document.getElementById(a):a,a&&(a.style.display="none")}}(),doShow=function(){return window.tmlversion<5.35?function(a){a="string"==typeof a?document.getElementById(a):a,a&&(a.className="")}:function(a){a="string"==typeof a?document.getElementById(a):a,a&&(a.style.display="")}}();window.INST_COMP=4;var G=G||{};G.currentPage="login",G.dkey=G.dkey||{},G.dkey.ready="100",G.dkey.error="200",G.info=G.info||{},G.info.isReLogin=null,document.body?LoginState.publish("onload"):addEvent(window,"load",function(){LoginState.publish("onload")});var LoginEncrypt={password:"",encrypt:function(){var a=1,b=$ID(client.N_INPUTPASS).value,c=$ID("formLogin").action,d=-1===c.indexOf("?")?"?":"&";is.set(client.EncryptKey)&&client.EncryptKey&&!isAnonymousButton()?(a=1,b=rsaEncrypt(b)):a=0,$ID("formLogin").action=c+d+"encrypt="+a,LoginEncrypt.password=b},setInput:function(){$ID(client.N_INPUTPASS).value=LoginEncrypt.password}};"unit"!==G.debug&&LoginState.publish("jsLoad");